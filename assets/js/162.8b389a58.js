(window.webpackJsonp=window.webpackJsonp||[]).push([[162],{438:function(t,s,a){"use strict";a.r(s);var n=a(10),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"springboot2-x-中使用-redis-的-bitmap"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#springboot2-x-中使用-redis-的-bitmap"}},[t._v("#")]),t._v(" SpringBoot2.x 中使用 Redis 的 bitmap")]),t._v(" "),s("blockquote",[s("p",[t._v("位图主要用于快速检索关键字状态，通常要求关键字是一个连续的序列（或者关键字是一个连续序列中的大部分），\n最基本的情况，使用1bit标示一个关键字的状态（可标示两种状态），\n但根据需要也可以使用2bit（标示4种状态），3bit（标示8种状态）。\n位图的主要应用场合：标示连续（或接近连续，即大部分会出现）的关键字序列的状态（状态数/关键字个数 越小越好）。")])]),t._v(" "),s("p",[s("code",[t._v("Redis")]),t._v(" 其实只支持 "),s("code",[t._v("5")]),t._v(" 种数据类型，并没有 "),s("code",[t._v("BitMap")]),t._v(" 这种类型，"),s("code",[t._v("BitMap")]),t._v(" 底层是基于 "),s("code",[t._v("Redis")]),t._v(" 的字符串类型实现的。")]),t._v(" "),s("h2",{attrs:{id:"应用场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#应用场景"}},[t._v("#")]),t._v(" 应用场景")]),t._v(" "),s("h3",{attrs:{id:"用户签到"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#用户签到"}},[t._v("#")]),t._v(" 用户签到")]),t._v(" "),s("p",[t._v("很多网站都提供了签到功能，并且需要展示最近一个月的签到情况，这种情况可以使用 BitMap 来实现。\n根据日期 offset = （今天是一年中的第几天） % （今年的天数），key = 年份：用户id。")]),t._v(" "),s("h3",{attrs:{id:"用户在线状态"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#用户在线状态"}},[t._v("#")]),t._v(" 用户在线状态")]),t._v(" "),s("p",[t._v("使用日期作为 key，然后用户 id 为 offset，如果当日活跃过就设置为1。")]),t._v(" "),s("h3",{attrs:{id:"统计活跃用户"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#统计活跃用户"}},[t._v("#")]),t._v(" 统计活跃用户")]),t._v(" "),s("p",[t._v("如果需要提供一个查询当前用户是否在线的接口，也可以考虑使用BitMap 。即节约空间效率又高，只需要一个key，然后用户id为offset，如果在线就设置为1，不在线就设置为0。\n具体步骤如下：")]),t._v(" "),s("ul",[s("li",[t._v("使用每个用户的唯一标识映射一个偏移量，比如使用"),s("code",[t._v("id")]),t._v("，这里可以把"),s("code",[t._v("id")]),t._v("换算成一个数字或直接使用id的二进制值作为该用户在当天是否活跃偏移量")]),t._v(" "),s("li",[t._v("用户登录则把该用户偏移量上的位值设置为"),s("code",[t._v("1")])]),t._v(" "),s("li",[t._v("每天按日期生成一个位图（"),s("code",[t._v("bitmap")]),t._v("）")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("stringRedisTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("opsForValue")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setBit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dayKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Boolean")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TRUE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("ul",[s("li",[t._v("计算日活则使用"),s("code",[t._v("bitcount")]),t._v("即可获得一个"),s("code",[t._v("key")]),t._v("的位值为"),s("code",[t._v("1")]),t._v("的量")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),t._v(" dayActivityNum "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" stringRedisTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("execute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RedisCallback")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" con "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" con"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bitCount")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dayKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getBytes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nlog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"用户日活: {}"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dayActivityNum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("ul",[s("li",[t._v("计算月活（一个月内登陆的用户去重总数）即可把"),s("code",[t._v("30")]),t._v("天的所有"),s("code",[t._v("bitmap")]),t._v("做"),s("code",[t._v("or")]),t._v("计算，然后再计算"),s("code",[t._v("bitcount")])])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" maxDayNum "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" bytes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("maxDayNum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" offset "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" offset "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" maxDayNum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" offset"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    bytes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("offset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StrUtil")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("format")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{}{}"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" userActivityKeyPrefix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DateUtil")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("format")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DateUtil")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("offsetDay")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("offset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PURE_DATE_FORMAT")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getBytes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" monthKey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StrUtil")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("format")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{}{}"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" userActivityKeyPrefix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nstringRedisTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("execute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RedisCallback")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" con "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" con"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bitOp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RedisStringCommands"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BitOperation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("OR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        monthKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getBytes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" bytes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),t._v(" monthActivityNum "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" stringRedisTemplate\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("execute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RedisCallback")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" con "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" con"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bitCount")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("monthKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getBytes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nlog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"用户月活：{}"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" monthActivityNum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br")])]),s("ul",[s("li",[t._v("计算留存率（次日留存=昨天今天连续登录的人数/昨天登录的人数） 即昨天的"),s("code",[t._v("bitmap")]),t._v("与今天的"),s("code",[t._v("bitmap")]),t._v("做"),s("code",[t._v("and")]),t._v("计算再做"),s("code",[t._v("bitcount")]),t._v("就得到连续登录人数，"),s("code",[t._v("bitcount")]),t._v("得到昨天登录人数，就可以通过公式计算出次日留存。")])]),t._v(" "),s("h3",{attrs:{id:"实现布隆过滤器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实现布隆过滤器"}},[t._v("#")]),t._v(" 实现布隆过滤器")]),t._v(" "),s("h2",{attrs:{id:"redis-的-bitmap-命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#redis-的-bitmap-命令"}},[t._v("#")]),t._v(" Redis 的 bitmap 命令")]),t._v(" "),s("h3",{attrs:{id:"setbit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#setbit"}},[t._v("#")]),t._v(" setbit")]),t._v(" "),s("p",[t._v("设置或修改key上的偏移量（offset）的位（value）的值。")]),t._v(" "),s("ul",[s("li",[t._v("语法：setbit key offset value")]),t._v(" "),s("li",[t._v("返回值：指定偏移量（offset）原来存储的值。")])]),t._v(" "),s("h3",{attrs:{id:"getbit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#getbit"}},[t._v("#")]),t._v(" getbit")]),t._v(" "),s("p",[t._v("查询key所存储的字符串值，获取偏移量上的位。")]),t._v(" "),s("ul",[s("li",[t._v("语法：getbit key offset")]),t._v(" "),s("li",[t._v("返回值：返回指定key上的偏移量，若key不存在，那么返回0。")])]),t._v(" "),s("h3",{attrs:{id:"bitcount"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#bitcount"}},[t._v("#")]),t._v(" bitcount")]),t._v(" "),s("p",[t._v("计算给定key的字符串值中，被设置为1的位bit的数量")]),t._v(" "),s("ul",[s("li",[t._v("语法：bitcount key [start] [end]")]),t._v(" "),s("li",[t._v("返回值：1比特位的数量")])]),t._v(" "),s("h3",{attrs:{id:"bitop"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#bitop"}},[t._v("#")]),t._v(" bitop")]),t._v(" "),s("p",[t._v("对一个或多个保存二进制的字符串key进行元操作，并将结果保存到destkey上。")]),t._v(" "),s("ul",[s("li",[t._v("语法：operation可以是and、or、not、xor的一种。")]),t._v(" "),s("li",[t._v("bitop and destkey key [key...]，对一个或多个key逻辑并，结果保存到destkey。")]),t._v(" "),s("li",[t._v("bitop or destkey key [key...]，对一个或多个key逻辑或，结果保存到destkey。")]),t._v(" "),s("li",[t._v("bitop xor destkey key [key...]，对一个或多个key逻辑异或，结果保存到destkey。")]),t._v(" "),s("li",[t._v("bitop xor destkey key，对一个或多个key逻辑非，结果保存到destkey。")]),t._v(" "),s("li",[t._v("除了"),s("code",[t._v("NOT")]),t._v("之外，其他操作多可以接受一个或多个key作为输入。")])]),t._v(" "),s("p",[s("code",[t._v("BITOP")]),t._v("的时间复杂度是"),s("code",[t._v("O(N)")]),t._v("，当处理大型矩阵或者大量数据统计时，最好将任务指派到附属节点（slave）进行，避免阻塞主节点。")]),t._v(" "),s("h2",{attrs:{id:"bitmap-导致大-key"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#bitmap-导致大-key"}},[t._v("#")]),t._v(" bitmap 导致大 KEY")]),t._v(" "),s("p",[t._v("bitmap推荐的偏移量是从1一直累加的，但是计算出的hash值为10位（10亿级别），那么占用的内存大小为239MB，若是计算出的hash值为7位（百万级别）占用的内存大小为124KB。")]),t._v(" "),s("p",[t._v("所以计算偏移量的时候不能无脑的进行hash得到，而是要根据系统情况（百万级别的日活、十万级别日活），进行取余计算，得到合适的偏移量。")]),t._v(" "),s("p",[t._v("解决方案是对数据进行分组在分片：")]),t._v(" "),s("ul",[s("li",[t._v("不仅可以避免"),s("code",[t._v("bitmap")]),t._v("导致"),s("code",[t._v("大key")]),t._v("。")]),t._v(" "),s("li",[t._v("避免出现范围用户太多导致查询时出现"),s("code",[t._v("热key")]),t._v("。")])])])}),[],!1,null,null,null);s.default=e.exports}}]);