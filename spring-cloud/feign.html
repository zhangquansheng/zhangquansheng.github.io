<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 Feign 实现声明式 REST 调用 | 新征程软件技术平台</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="简化开发 效率至上">
    <meta name="keywords" content="新征程软件技术平台,新征程,zhengcheng.plus">
    
    <link rel="preload" href="/assets/css/0.styles.27274be1.css" as="style"><link rel="preload" href="/assets/js/app.ead2daf9.js" as="script"><link rel="preload" href="/assets/js/2.a6437284.js" as="script"><link rel="preload" href="/assets/js/194.f5088931.js" as="script"><link rel="prefetch" href="/assets/js/10.b8a46e93.js"><link rel="prefetch" href="/assets/js/100.5449f6c6.js"><link rel="prefetch" href="/assets/js/101.e0197bff.js"><link rel="prefetch" href="/assets/js/102.06bc2bf8.js"><link rel="prefetch" href="/assets/js/103.e7dd12df.js"><link rel="prefetch" href="/assets/js/104.b0b6ed15.js"><link rel="prefetch" href="/assets/js/105.23f6ec3f.js"><link rel="prefetch" href="/assets/js/106.a2f2745b.js"><link rel="prefetch" href="/assets/js/107.71a3e3e1.js"><link rel="prefetch" href="/assets/js/108.4d279068.js"><link rel="prefetch" href="/assets/js/109.5521cedb.js"><link rel="prefetch" href="/assets/js/11.59a9af74.js"><link rel="prefetch" href="/assets/js/110.2f722f06.js"><link rel="prefetch" href="/assets/js/111.85eb805a.js"><link rel="prefetch" href="/assets/js/112.ca466a4f.js"><link rel="prefetch" href="/assets/js/113.5fa1078d.js"><link rel="prefetch" href="/assets/js/114.497b6331.js"><link rel="prefetch" href="/assets/js/115.7c2e9ca5.js"><link rel="prefetch" href="/assets/js/116.5420d702.js"><link rel="prefetch" href="/assets/js/117.b59943be.js"><link rel="prefetch" href="/assets/js/118.8d163c13.js"><link rel="prefetch" href="/assets/js/119.b3542a0b.js"><link rel="prefetch" href="/assets/js/12.96550b57.js"><link rel="prefetch" href="/assets/js/120.679735ef.js"><link rel="prefetch" href="/assets/js/121.f07adaea.js"><link rel="prefetch" href="/assets/js/122.d98ec67a.js"><link rel="prefetch" href="/assets/js/123.a5602b0e.js"><link rel="prefetch" href="/assets/js/124.fd3effe8.js"><link rel="prefetch" href="/assets/js/125.6970355a.js"><link rel="prefetch" href="/assets/js/126.6db09cc9.js"><link rel="prefetch" href="/assets/js/127.b52fe1fc.js"><link rel="prefetch" href="/assets/js/128.e65bde4b.js"><link rel="prefetch" href="/assets/js/129.56e5a52f.js"><link rel="prefetch" href="/assets/js/13.52396eb8.js"><link rel="prefetch" href="/assets/js/130.0c7f3627.js"><link rel="prefetch" href="/assets/js/131.974bf58a.js"><link rel="prefetch" href="/assets/js/132.84a546b6.js"><link rel="prefetch" href="/assets/js/133.3f36e0b1.js"><link rel="prefetch" href="/assets/js/134.7dae7fb1.js"><link rel="prefetch" href="/assets/js/135.2c978975.js"><link rel="prefetch" href="/assets/js/136.5a718b60.js"><link rel="prefetch" href="/assets/js/137.c5184277.js"><link rel="prefetch" href="/assets/js/138.06cb9068.js"><link rel="prefetch" href="/assets/js/139.50121c76.js"><link rel="prefetch" href="/assets/js/14.b7877532.js"><link rel="prefetch" href="/assets/js/140.aebfb423.js"><link rel="prefetch" href="/assets/js/141.f02fb302.js"><link rel="prefetch" href="/assets/js/142.d7214f5c.js"><link rel="prefetch" href="/assets/js/143.ca9155c0.js"><link rel="prefetch" href="/assets/js/144.4ab850cd.js"><link rel="prefetch" href="/assets/js/145.908ec2d6.js"><link rel="prefetch" href="/assets/js/146.fc5cacde.js"><link rel="prefetch" href="/assets/js/147.af28add9.js"><link rel="prefetch" href="/assets/js/148.2f643c96.js"><link rel="prefetch" href="/assets/js/149.cef10614.js"><link rel="prefetch" href="/assets/js/15.0229b36a.js"><link rel="prefetch" href="/assets/js/150.79fe2c45.js"><link rel="prefetch" href="/assets/js/151.12e3049b.js"><link rel="prefetch" href="/assets/js/152.1ae2feb6.js"><link rel="prefetch" href="/assets/js/153.38538b45.js"><link rel="prefetch" href="/assets/js/154.fd959fa0.js"><link rel="prefetch" href="/assets/js/155.6182c85e.js"><link rel="prefetch" href="/assets/js/156.e0cb6967.js"><link rel="prefetch" href="/assets/js/157.b5e6ce43.js"><link rel="prefetch" href="/assets/js/158.5d7953bb.js"><link rel="prefetch" href="/assets/js/159.46ec82dc.js"><link rel="prefetch" href="/assets/js/16.29887542.js"><link rel="prefetch" href="/assets/js/160.4bbfa3c4.js"><link rel="prefetch" href="/assets/js/161.73c7d02e.js"><link rel="prefetch" href="/assets/js/162.8b389a58.js"><link rel="prefetch" href="/assets/js/163.acaf7edb.js"><link rel="prefetch" href="/assets/js/164.4f065507.js"><link rel="prefetch" href="/assets/js/165.3d59d9c0.js"><link rel="prefetch" href="/assets/js/166.174f0ba4.js"><link rel="prefetch" href="/assets/js/167.677c8aa3.js"><link rel="prefetch" href="/assets/js/168.81c1286e.js"><link rel="prefetch" href="/assets/js/169.a167628f.js"><link rel="prefetch" href="/assets/js/17.722de29e.js"><link rel="prefetch" href="/assets/js/170.9de6ee5a.js"><link rel="prefetch" href="/assets/js/171.226ac8e2.js"><link rel="prefetch" href="/assets/js/172.44dc93a1.js"><link rel="prefetch" href="/assets/js/173.ca8e2027.js"><link rel="prefetch" href="/assets/js/174.42e1d0a1.js"><link rel="prefetch" href="/assets/js/175.d8d68988.js"><link rel="prefetch" href="/assets/js/176.2b309f4a.js"><link rel="prefetch" href="/assets/js/177.a12d721d.js"><link rel="prefetch" href="/assets/js/178.b6022798.js"><link rel="prefetch" href="/assets/js/179.b6224ee3.js"><link rel="prefetch" href="/assets/js/18.80b04431.js"><link rel="prefetch" href="/assets/js/180.adffa8f0.js"><link rel="prefetch" href="/assets/js/181.7f66a9ff.js"><link rel="prefetch" href="/assets/js/182.3a126cd8.js"><link rel="prefetch" href="/assets/js/183.a420ac49.js"><link rel="prefetch" href="/assets/js/184.15101821.js"><link rel="prefetch" href="/assets/js/185.2bf189e4.js"><link rel="prefetch" href="/assets/js/186.dcfb5289.js"><link rel="prefetch" href="/assets/js/187.c6198301.js"><link rel="prefetch" href="/assets/js/188.46474ca5.js"><link rel="prefetch" href="/assets/js/189.a727bb70.js"><link rel="prefetch" href="/assets/js/19.6257f393.js"><link rel="prefetch" href="/assets/js/190.3419d518.js"><link rel="prefetch" href="/assets/js/191.fa54de93.js"><link rel="prefetch" href="/assets/js/192.5ae22a76.js"><link rel="prefetch" href="/assets/js/193.7630ba2c.js"><link rel="prefetch" href="/assets/js/195.68cf6439.js"><link rel="prefetch" href="/assets/js/196.f8d90256.js"><link rel="prefetch" href="/assets/js/197.8dd9babf.js"><link rel="prefetch" href="/assets/js/198.ee859666.js"><link rel="prefetch" href="/assets/js/199.9b66274a.js"><link rel="prefetch" href="/assets/js/20.1b27d815.js"><link rel="prefetch" href="/assets/js/200.39be699b.js"><link rel="prefetch" href="/assets/js/201.d627a26e.js"><link rel="prefetch" href="/assets/js/202.3db9c4f9.js"><link rel="prefetch" href="/assets/js/203.2fca93f1.js"><link rel="prefetch" href="/assets/js/204.db1f1f41.js"><link rel="prefetch" href="/assets/js/205.b869bf2e.js"><link rel="prefetch" href="/assets/js/206.2feba09f.js"><link rel="prefetch" href="/assets/js/207.2c780161.js"><link rel="prefetch" href="/assets/js/208.d4c07a40.js"><link rel="prefetch" href="/assets/js/209.9e513793.js"><link rel="prefetch" href="/assets/js/21.fd2a85e5.js"><link rel="prefetch" href="/assets/js/210.1855e568.js"><link rel="prefetch" href="/assets/js/211.79df258d.js"><link rel="prefetch" href="/assets/js/212.75f8ddd8.js"><link rel="prefetch" href="/assets/js/213.f5966c63.js"><link rel="prefetch" href="/assets/js/214.23f03947.js"><link rel="prefetch" href="/assets/js/22.ff9d13cc.js"><link rel="prefetch" href="/assets/js/23.e4633021.js"><link rel="prefetch" href="/assets/js/24.457827de.js"><link rel="prefetch" href="/assets/js/25.6ab6c8c0.js"><link rel="prefetch" href="/assets/js/26.3b63e45f.js"><link rel="prefetch" href="/assets/js/27.e91613f4.js"><link rel="prefetch" href="/assets/js/28.1e594a48.js"><link rel="prefetch" href="/assets/js/29.7790a717.js"><link rel="prefetch" href="/assets/js/3.2106d22d.js"><link rel="prefetch" href="/assets/js/30.ee6afb18.js"><link rel="prefetch" href="/assets/js/31.5b1db076.js"><link rel="prefetch" href="/assets/js/32.949bbf53.js"><link rel="prefetch" href="/assets/js/33.225cf856.js"><link rel="prefetch" href="/assets/js/34.d58bdf78.js"><link rel="prefetch" href="/assets/js/35.8236c6ac.js"><link rel="prefetch" href="/assets/js/36.9be52b2f.js"><link rel="prefetch" href="/assets/js/37.377f2735.js"><link rel="prefetch" href="/assets/js/38.d656a887.js"><link rel="prefetch" href="/assets/js/39.73fab100.js"><link rel="prefetch" href="/assets/js/4.83b9aa6e.js"><link rel="prefetch" href="/assets/js/40.47829520.js"><link rel="prefetch" href="/assets/js/41.5c0d8d77.js"><link rel="prefetch" href="/assets/js/42.af2b3775.js"><link rel="prefetch" href="/assets/js/43.9fca6af7.js"><link rel="prefetch" href="/assets/js/44.c7f394df.js"><link rel="prefetch" href="/assets/js/45.86fb5022.js"><link rel="prefetch" href="/assets/js/46.30af5dc2.js"><link rel="prefetch" href="/assets/js/47.240cbaf3.js"><link rel="prefetch" href="/assets/js/48.b927f891.js"><link rel="prefetch" href="/assets/js/49.69519611.js"><link rel="prefetch" href="/assets/js/5.d389cf02.js"><link rel="prefetch" href="/assets/js/50.49044f4d.js"><link rel="prefetch" href="/assets/js/51.b8bcad67.js"><link rel="prefetch" href="/assets/js/52.41c8a45e.js"><link rel="prefetch" href="/assets/js/53.d843dc33.js"><link rel="prefetch" href="/assets/js/54.fb3e16b5.js"><link rel="prefetch" href="/assets/js/55.e2a79ba9.js"><link rel="prefetch" href="/assets/js/56.bddabbb9.js"><link rel="prefetch" href="/assets/js/57.66687cad.js"><link rel="prefetch" href="/assets/js/58.2291ce2b.js"><link rel="prefetch" href="/assets/js/59.97a1badf.js"><link rel="prefetch" href="/assets/js/6.5103b8a2.js"><link rel="prefetch" href="/assets/js/60.c350b16e.js"><link rel="prefetch" href="/assets/js/61.d6db83f9.js"><link rel="prefetch" href="/assets/js/62.fff9be52.js"><link rel="prefetch" href="/assets/js/63.8484031b.js"><link rel="prefetch" href="/assets/js/64.8f4ca9db.js"><link rel="prefetch" href="/assets/js/65.83c54b72.js"><link rel="prefetch" href="/assets/js/66.bd588d46.js"><link rel="prefetch" href="/assets/js/67.8370ab43.js"><link rel="prefetch" href="/assets/js/68.178311f9.js"><link rel="prefetch" href="/assets/js/69.fb8979a4.js"><link rel="prefetch" href="/assets/js/7.1389d685.js"><link rel="prefetch" href="/assets/js/70.c151a1b1.js"><link rel="prefetch" href="/assets/js/71.8331c466.js"><link rel="prefetch" href="/assets/js/72.c7af0a20.js"><link rel="prefetch" href="/assets/js/73.78d2950b.js"><link rel="prefetch" href="/assets/js/74.76b3a638.js"><link rel="prefetch" href="/assets/js/75.94ebf08f.js"><link rel="prefetch" href="/assets/js/76.0839cd8b.js"><link rel="prefetch" href="/assets/js/77.5a28c1d3.js"><link rel="prefetch" href="/assets/js/78.ccb879e4.js"><link rel="prefetch" href="/assets/js/79.af16c646.js"><link rel="prefetch" href="/assets/js/8.97d867b2.js"><link rel="prefetch" href="/assets/js/80.3d254d9b.js"><link rel="prefetch" href="/assets/js/81.0a23a807.js"><link rel="prefetch" href="/assets/js/82.d106eba1.js"><link rel="prefetch" href="/assets/js/83.874deb86.js"><link rel="prefetch" href="/assets/js/84.16bd91e7.js"><link rel="prefetch" href="/assets/js/85.bad29fef.js"><link rel="prefetch" href="/assets/js/86.6904d3ec.js"><link rel="prefetch" href="/assets/js/87.dd00dff1.js"><link rel="prefetch" href="/assets/js/88.404e4644.js"><link rel="prefetch" href="/assets/js/89.4434442d.js"><link rel="prefetch" href="/assets/js/9.7400a8f9.js"><link rel="prefetch" href="/assets/js/90.a4a8d4b5.js"><link rel="prefetch" href="/assets/js/91.e6e9f3b6.js"><link rel="prefetch" href="/assets/js/92.f6c88662.js"><link rel="prefetch" href="/assets/js/93.266473c2.js"><link rel="prefetch" href="/assets/js/94.29e5dee0.js"><link rel="prefetch" href="/assets/js/95.63d64699.js"><link rel="prefetch" href="/assets/js/96.03353f2a.js"><link rel="prefetch" href="/assets/js/97.1e6f4a58.js"><link rel="prefetch" href="/assets/js/98.504bf2c8.js"><link rel="prefetch" href="/assets/js/99.6ad11b18.js">
    <link rel="stylesheet" href="/assets/css/0.styles.27274be1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="新征程软件技术平台" class="logo"> <span class="site-name can-hide">新征程软件技术平台</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JAVA" class="dropdown-title"><span class="title">JAVA</span> <span class="arrow down"></span></button> <button type="button" aria-label="JAVA" class="mobile-dropdown-title"><span class="title">JAVA</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/HashMap.html" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/jvm/" class="nav-link">
  JVM
</a></li><li class="dropdown-item"><!----> <a href="/concurrent/synchronized.html" class="nav-link">
  并发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithms/" class="nav-link">
  数据结构与算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/es/" class="nav-link">
  Elasticsearch
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用框架" class="dropdown-title"><span class="title">常用框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用框架" class="mobile-dropdown-title"><span class="title">常用框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/spring-boot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/spring-cloud/feign/" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/mybatis/" class="nav-link">
  MyBatis
</a></li><li class="dropdown-item"><!----> <a href="/shardingsphere/" class="nav-link">
  Apache ShardingSphere
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="系统设计" class="dropdown-title"><span class="title">系统设计</span> <span class="arrow down"></span></button> <button type="button" aria-label="系统设计" class="mobile-dropdown-title"><span class="title">系统设计</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-patterns/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/system-design/seckill/" class="nav-link">
  秒杀系统
</a></li><li class="dropdown-item"><!----> <a href="/source-code-hunter/http-long-polling/" class="nav-link">
  源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/kafka/" class="nav-link">
  Kafka
</a></li><li class="dropdown-item"><!----> <a href="/zk/" class="nav-link">
  ZooKeeper
</a></li><li class="dropdown-item"><!----> <a href="/rocketmq/" class="nav-link">
  RocketMQ
</a></li></ul></div></div><div class="nav-item"><a href="/guide/" class="nav-link">
  zhengcheng 开发指南
</a></div><div class="nav-item"><a href="/change-log/" class="nav-link">
  更新日志
</a></div><div class="nav-item"><a href="https://github.com/zhangquansheng/zhengcheng-parent" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JAVA" class="dropdown-title"><span class="title">JAVA</span> <span class="arrow down"></span></button> <button type="button" aria-label="JAVA" class="mobile-dropdown-title"><span class="title">JAVA</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/HashMap.html" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/jvm/" class="nav-link">
  JVM
</a></li><li class="dropdown-item"><!----> <a href="/concurrent/synchronized.html" class="nav-link">
  并发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithms/" class="nav-link">
  数据结构与算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/es/" class="nav-link">
  Elasticsearch
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用框架" class="dropdown-title"><span class="title">常用框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用框架" class="mobile-dropdown-title"><span class="title">常用框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/spring-boot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/spring-cloud/feign/" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/mybatis/" class="nav-link">
  MyBatis
</a></li><li class="dropdown-item"><!----> <a href="/shardingsphere/" class="nav-link">
  Apache ShardingSphere
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="系统设计" class="dropdown-title"><span class="title">系统设计</span> <span class="arrow down"></span></button> <button type="button" aria-label="系统设计" class="mobile-dropdown-title"><span class="title">系统设计</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-patterns/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/system-design/seckill/" class="nav-link">
  秒杀系统
</a></li><li class="dropdown-item"><!----> <a href="/source-code-hunter/http-long-polling/" class="nav-link">
  源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/kafka/" class="nav-link">
  Kafka
</a></li><li class="dropdown-item"><!----> <a href="/zk/" class="nav-link">
  ZooKeeper
</a></li><li class="dropdown-item"><!----> <a href="/rocketmq/" class="nav-link">
  RocketMQ
</a></li></ul></div></div><div class="nav-item"><a href="/guide/" class="nav-link">
  zhengcheng 开发指南
</a></div><div class="nav-item"><a href="/change-log/" class="nav-link">
  更新日志
</a></div><div class="nav-item"><a href="https://github.com/zhangquansheng/zhengcheng-parent" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>好站</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/awesome/" class="sidebar-link">Awesome</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/java8-func.html" class="sidebar-link">Java 8 函数式编程</a></li><li><a href="/java/java8-stream.html" class="sidebar-link">Java 8 Stream API</a></li><li><a href="/java/java-basic-datatypes.html" class="sidebar-link">Java 基本数据类型</a></li><li><a href="/java/generics.html" class="sidebar-link">泛型（参数化类型）</a></li><li><a href="/java/reference.html" class="sidebar-link">Reference 引用</a></li><li><a href="/java/abstract-interface.html" class="sidebar-link">抽象类 VS 接口</a></li><li><a href="/java/HashMap.html" class="sidebar-link">HashMap</a></li><li><a href="/java/ConcurrentHashMap.html" class="sidebar-link">ConcurrentHashMap</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java 虚拟机底层原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jvm/" class="sidebar-link">JVM</a></li><li><a href="/jvm/gc.html" class="sidebar-link">JVM 垃圾回收(GC)</a></li><li><a href="/jvm/cms.html" class="sidebar-link">CMS (Concurrent Mark Sweep 并发标记清理)</a></li><li><a href="/jvm/g1.html" class="sidebar-link">G1 - Garbage First(垃圾优先算法)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>并发编程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/concurrent/volatile.html" class="sidebar-link">volatile 关键字</a></li><li><a href="/concurrent/synchronized.html" class="sidebar-link">synchronized 底层实现</a></li><li><a href="/concurrent/cas.html" class="sidebar-link">CAS 乐观锁 🔨</a></li><li><a href="/concurrent/AQS.html" class="sidebar-link">AQS 抽象队列同步器 🔨</a></li><li><a href="/concurrent/thread-local.html" class="sidebar-link">ThreadLocal （线程局部变量） 👍</a></li><li><a href="/concurrent/thread-pool-executor.html" class="sidebar-link">ThreadPoolExecutor 线程池 👍</a></li><li><a href="/concurrent/Future.html" class="sidebar-link">Future 模式</a></li><li><a href="/concurrent/CompletableFuture.html" class="sidebar-link">Java 8 CompletableFuture 多线程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/algorithms/" class="sidebar-link">概览</a></li><li><a href="/algorithms/algorithms-think.html" class="sidebar-link">算法思维 🔨</a></li><li><a href="/algorithms/binary-tree.html" class="sidebar-link">二叉树</a></li><li><a href="/algorithms/sort.html" class="sidebar-link">经典排序算法</a></li><li><a href="/algorithms/data-structure.html" class="sidebar-link">数据结构：数组、链表、栈、队列的理解</a></li><li><a href="/algorithms/dynamic-programming.html" class="sidebar-link">动态规划（DP）算法</a></li><li><a href="/algorithms/lru.html" class="sidebar-link">LRU 🔨</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>面向对象设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/design-patterns/" class="sidebar-link">概述</a></li><li><a href="/design-patterns/factory.html" class="sidebar-link">工厂模式</a></li><li><a href="/design-patterns/abstract-factory.html" class="sidebar-link">抽象工厂模式</a></li><li><a href="/design-patterns/builder.html" class="sidebar-link">建造者模式</a></li><li><a href="/design-patterns/adapter.html" class="sidebar-link">适配器模式</a></li><li><a href="/design-patterns/singleton.html" class="sidebar-link">单例模式</a></li><li><a href="/design-patterns/strategy.html" class="sidebar-link">策略模式</a></li><li><a href="/design-patterns/template.html" class="sidebar-link">模板模式</a></li><li><a href="/design-patterns/facade.html" class="sidebar-link">Facade （门面模式）</a></li><li><a href="/design-patterns/flyweight.html" class="sidebar-link">享元模式</a></li><li><a href="/design-patterns/proxy.html" class="sidebar-link">代理模式</a></li><li><a href="/design-patterns/chain-of-responsibility.html" class="sidebar-link">责任链模式</a></li><li><a href="/design-patterns/mediator.html" class="sidebar-link">中介者模式</a></li><li><a href="/design-patterns/principle.html" class="sidebar-link">面向对象设计原则</a></li><li><a href="/design-patterns/ifelse-1.html" class="sidebar-link">消除代码中的if(一) 💯</a></li><li><a href="/design-patterns/ifelse-2.html" class="sidebar-link">消除代码中的if(二)</a></li><li><a href="/design-patterns/dynamic-proxy.html" class="sidebar-link">动态代理的实现</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mysql/" class="sidebar-link">概述</a></li><li><a href="/mysql/Infrastructure.html" class="sidebar-link">基础架构</a></li><li><a href="/mysql/b-plus-index.html" class="sidebar-link">索引</a></li><li><a href="/mysql/ICP.html" class="sidebar-link">ICP</a></li><li><a href="/mysql/locking.html" class="sidebar-link">锁</a></li><li><a href="/mysql/transaction.html" class="sidebar-link">事务</a></li><li><a href="/mysql/sql-standard.html" class="sidebar-link">MySQL 高性能优化规范</a></li><li><a href="/mysql/database-design-paradigm.html" class="sidebar-link">数据库设计范式</a></li><li><a href="/mysql/innodb_trx.html" class="sidebar-link">MySQL 表死锁解决方案</a></li><li><a href="/mysql/datetime.html" class="sidebar-link">MySQL 自动将 23:59:59.999 保存成 00:00:00 的问题记录</a></li><li><a href="/mysql/update.html" class="sidebar-link">MySQL 中 UPDATE 语句的返回值问题汇总</a></li><li><a href="/mysql/delete.html" class="sidebar-link">为什么 MySQL 不建议使用 delete 删除数据？ &amp; Truncate 相关命令用法</a></li><li><a href="/mysql/sql-execute.html" class="sidebar-link">SQL 语句在 MySQL 中执行过程</a></li><li><a href="/mysql/index-invalid.html" class="sidebar-link">MySQL 索引失效</a></li><li><a href="/mysql/department-highest-salary.html" class="sidebar-link">部门工资最高的员工</a></li><li><a href="/mysql/having.html" class="sidebar-link">SQL HAVING 子句</a></li><li><a href="/mysql/MySQL-8.html" class="sidebar-link">MySQL8.0</a></li><li><a href="/mysql/limit_order_by.html" class="sidebar-link">MySQL排序分页查询数据顺序错乱</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MyBatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mybatis/" class="sidebar-link">概述</a></li><li><a href="/mybatis/cache.html" class="sidebar-link">缓存</a></li><li><a href="/mybatis/mybatis-crud.html" class="sidebar-link">Mybatis3 通过 provider 注解结合动态 sql 实现 CRUD</a></li><li><a href="/mybatis/MyBatis-Plus.html" class="sidebar-link">Mybatis-Plus 实现动态 SQL 语句的源码解析</a></li><li><a href="/mybatis/DataPermissionHandler.html" class="sidebar-link">MyBatis-Plus 结合 Spring Boot 基于 DataPermissionInterceptor 实现数据权限</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Apache ShardingSphere</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/shardingsphere/" class="sidebar-link">概览</a></li><li><a href="/shardingsphere/concept.html" class="sidebar-link">核心概念</a></li><li><a href="/shardingsphere/getting-started.html" class="sidebar-link">快速入门</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/redis/" class="sidebar-link">概述</a></li><li><a href="/redis/data-types.html" class="sidebar-link">Redis数据类型简介</a></li><li><a href="/redis/memory.html" class="sidebar-link">Redis 内存</a></li><li><a href="/redis/reactor.html" class="sidebar-link">Redis 线程模型</a></li><li><a href="/redis/three-problems-of-cache.html" class="sidebar-link">缓存问题之缓存穿透、缓存击穿、缓存雪崩及其解决方案</a></li><li><a href="/redis/cache-database-double-write-consistency.html" class="sidebar-link">如何保证缓存与数据库的双写一致性</a></li><li><a href="/redis/redisson-lock.html" class="sidebar-link">Redisson 分布式锁 👍</a></li><li><a href="/redis/big-key.html" class="sidebar-link">Redis大key多key拆分方案</a></li><li><a href="/redis/bitmap.html" class="sidebar-link">SpringBoot2.x 中使用 Redis 的 bitmap</a></li><li><a href="/redis/delay-queue.html" class="sidebar-link">基于 Redis 实现延迟队列</a></li><li><a href="/redis/pub-sub.html" class="sidebar-link">SpringBoot Redis 发布订阅</a></li><li><a href="/redis/J2Cache.html" class="sidebar-link">J2Cache</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/spring/" class="sidebar-link">概述</a></li><li><a href="/spring/dependency-injection.html" class="sidebar-link">IoC</a></li><li><a href="/spring/beans.html" class="sidebar-link">Bean</a></li><li><a href="/spring/circular-dependencies.html" class="sidebar-link">Spring 循环依赖 🎉</a></li><li><a href="/spring/beans-annotation-config.html" class="sidebar-link">基于注解的容器配置（常用注解）</a></li><li><a href="/spring/transaction-declarative.html" class="sidebar-link">Spring 框架的声明式事务实现</a></li><li><a href="/spring/aop.html" class="sidebar-link">AOP</a></li><li><a href="/spring/validation.html" class="sidebar-link">验证，数据绑定和类型转换</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring Boot</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/spring-boot/" class="sidebar-link">概述</a></li><li><a href="/spring-boot/configuration-properties.html" class="sidebar-link">@ConfigurationProperties</a></li><li><a href="/spring-boot/redis-pubsub.html" class="sidebar-link">Spring Boot 实现 Redis 消息的发布订阅功能</a></li><li><a href="/spring-boot/spring-boot-starter.html" class="sidebar-link">Spring Boot Starter 原理</a></li><li><a href="/spring-boot/transaction-after.html" class="sidebar-link">SpringBoot 事务提交之后的操作保证</a></li><li><a href="/spring-boot/ContiPerf.html" class="sidebar-link">Spring Boot - 性能测试 ContiPerf</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spring Cloud</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/spring-cloud/feign.html" aria-current="page" class="active sidebar-link">使用 Feign 实现声明式 REST 调用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#设计原理" class="sidebar-link">设计原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_1-基于面向接口的动态代理方式生成实现类" class="sidebar-link">1. 基于面向接口的动态代理方式生成实现类</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_2-根据contract协议规则-解析接口类的注解信息" class="sidebar-link">2. 根据Contract协议规则，解析接口类的注解信息</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_3-基于-requestbean-动态生成-request" class="sidebar-link">3. 基于 RequestBean，动态生成 Request</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_4-使用encoder-将bean转换成-http报文正文-消息解析和转码逻辑" class="sidebar-link">4. 使用Encoder 将Bean转换成 Http报文正文（消息解析和转码逻辑）</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_5-拦截器负责对请求和返回进行装饰处理" class="sidebar-link">5. 拦截器负责对请求和返回进行装饰处理</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_6-日志记录" class="sidebar-link">6. 日志记录</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_7-基于重试器发送http请求" class="sidebar-link">7. 基于重试器发送HTTP请求</a></li></ul></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#实现原理" class="sidebar-link">实现原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_1-feign-client-通过-okhttpclient-完成-request-到-response-的一次请求" class="sidebar-link">1. Feign client 通过 OkHttpClient 完成 request 到 Response 的一次请求</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_2-okhttp-执行层" class="sidebar-link">2. okhttp 执行层</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_3-同步请求" class="sidebar-link">3. 同步请求</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_4-连接器执行过程" class="sidebar-link">4. 连接器执行过程</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_5-okhttp-拦截器-retryandfollowupinterceptor-重试机制" class="sidebar-link">5. Okhttp 拦截器 RetryAndFollowUpInterceptor 重试机制</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_6-okhttp-拦截器-bridgeinterceptor-桥梁" class="sidebar-link">6. Okhttp 拦截器 BridgeInterceptor 桥梁</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_7-okhttp3-拦截器-cacheinterceptor-缓存" class="sidebar-link">7. Okhttp3 拦截器  CacheInterceptor 缓存</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_8-okhttp3-拦截器-connectinterceptor-连接" class="sidebar-link">8. Okhttp3 拦截器 ConnectInterceptor 连接</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_9-okhttp3-拦截器-callserverinterceptor-网络调用" class="sidebar-link">9. Okhttp3 拦截器 CallServerInterceptor 网络调用</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#_10-connectionpool-实现" class="sidebar-link">10. ConnectionPool 实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#最佳实践" class="sidebar-link">最佳实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#整合-feign" class="sidebar-link">整合 Feign</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#自定义feign配置" class="sidebar-link">自定义Feign配置</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#使用feign构造多参数请求" class="sidebar-link">使用Feign构造多参数请求</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#使用feign上传文件" class="sidebar-link">使用Feign上传文件</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#feign-对继承的支持" class="sidebar-link">Feign 对继承的支持</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#feign-对压缩的支持" class="sidebar-link">Feign 对压缩的支持</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#feign-的日志" class="sidebar-link">Feign 的日志</a></li></ul></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#常见问题" class="sidebar-link">常见问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#同时配置-feign-和-ribbon-的超时时间的优先级" class="sidebar-link">同时配置 Feign 和 Ribbon 的超时时间的优先级</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#feign-启用hystrix-hystrix线程池隔离支持日志链路跟踪" class="sidebar-link">feign 启用Hystrix，Hystrix线程池隔离支持日志链路跟踪</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#feign-使用okhttp3" class="sidebar-link">Feign 使用OkHttp3</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#spring-cloud-之-feign、ribbon-设置超时时间" class="sidebar-link">Spring Cloud 之 Feign、Ribbon 设置超时时间</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#feign-长连接导致的异常" class="sidebar-link">Feign 长连接导致的异常</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#hystrix线程池如何合理配置" class="sidebar-link">hystrix线程池如何合理配置</a></li><li class="sidebar-sub-header"><a href="/spring-cloud/feign.html#何时会出现-hystrix-circuit-short-circuited-and-is-open" class="sidebar-link">何时会出现 Hystrix circuit short-circuited and is OPEN</a></li></ul></li></ul></li><li><a href="/spring-cloud/feign-dubbo.html" class="sidebar-link">以Dubbo暴露服务的方式使用Feign（Feign 继承）</a></li><li><a href="/spring-cloud/ribbon.html" class="sidebar-link">Ribbon</a></li><li><a href="/spring-cloud/refresh-scope.html" class="sidebar-link">@RefreshScope</a></li><li><a href="/spring-cloud/apollo-zuul.html" class="sidebar-link">携程 Apollo 整合 Zuul 网关实现动态网关刷新</a></li><li><a href="/spring-cloud/Hystrix.html" class="sidebar-link">Hystrix 👍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Elasticsearch</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/es/" class="sidebar-link">概述</a></li><li><a href="/es/inverted-index.html" class="sidebar-link">倒排索引</a></li><li><a href="/es/Query-DSL.html" class="sidebar-link">DSL(Domain Specified Language)领域专用语言</a></li><li><a href="/es/tokenizer.html" class="sidebar-link">分词器</a></li><li><a href="/es/aggregations.html" class="sidebar-link">Aggregations</a></li><li><a href="/es/restHighLevelClient.html" class="sidebar-link">RestHighLevelClient</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Kafka</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kafka/" class="sidebar-link">kafka</a></li><li><a href="/kafka/spring-kafka.html" class="sidebar-link">spring-kafka的使用和原理</a></li><li><a href="/kafka/multiple-kafka-config.html" class="sidebar-link">SpringBoot 配置多 Kafka 中心</a></li><li><a href="/kafka/message-sequencing.html" class="sidebar-link">Kafka 如何保证消息的顺序</a></li><li><a href="/kafka/spring-kafka-retry.html" class="sidebar-link">Kafka 重试机制</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ZooKeeper</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zk/" class="sidebar-link">概述</a></li><li><a href="/zk/zab.html" class="sidebar-link">ZAB的体系结构 - ZooKeeper原子广播协议</a></li><li><a href="/zk/watcher.html" class="sidebar-link">Watch 机制 🔨</a></li><li><a href="/zk/lock.html" class="sidebar-link">Curator 的ZK分布式锁实现原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>RocketMQ</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rocketmq/" class="sidebar-link">概述</a></li><li><a href="/rocketmq/message-queue.html" class="sidebar-link">消息队列基础问题</a></li><li><a href="/rocketmq/consumer.html" class="sidebar-link">RocketMQ 消息消费</a></li><li><a href="/rocketmq/message-idempotent.html" class="sidebar-link">基于消息幂等表的非事务方案</a></li><li><a href="/rocketmq/rocketmq-spring.html" class="sidebar-link">Spring Boot 集成 （一） 自定义注解</a></li><li><a href="/rocketmq/rocketmq-spring-apache.html" class="sidebar-link">Spring Boot 集成 （二） apache</a></li><li><a href="/rocketmq/transaction.html" class="sidebar-link">RocketMQ 支持事务消息机制的实现原理</a></li><li><a href="/rocketmq/delay.html" class="sidebar-link">深入理解 RocketMQ 延迟消息 🔨</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>系统设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/system-design/auto-cancel.html" class="sidebar-link">生成订单30分钟未支付，则自动取消，该怎么实现？</a></li><li><a href="/system-design/duplicate-pay.html" class="sidebar-link">如何防止订单重复支付？</a></li><li><a href="/system-design/sign-auth.html" class="sidebar-link">API 接口防止参数篡改和重放攻击</a></li><li><a href="/system-design/seckill.html" class="sidebar-link">如何设计一个秒杀系统？ 👍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>源码分析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/source-code-hunter/xxl-job.html" class="sidebar-link">XXL-JOB架构源码解析</a></li><li><a href="/source-code-hunter/http-long-polling.html" class="sidebar-link">Http Long Polling</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>zhengcheng 开发指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" class="sidebar-link">简介</a></li><li><a href="/guide/getting-started.html" class="sidebar-link">快速上手</a></li><li><a href="/guide/web-core.html" class="sidebar-link">核心模块</a></li><li><a href="/guide/mybatis-plus.html" class="sidebar-link">mybatis-plus 通用组件</a></li><li><a href="/guide/dynamic-datasource.html" class="sidebar-link">多数据源配置 &amp; dynamic-datasource-spring-boot-starter</a></li><li><a href="/guide/cache.html" class="sidebar-link">Redis 缓存</a></li><li><a href="/guide/idempotent.html" class="sidebar-link">自定义接口幂等性注解 @Idempotent （基于redis缓存）</a></li><li><a href="/guide/feign.html" class="sidebar-link">Feign</a></li><li><a href="/guide/async.html" class="sidebar-link">异步线程池</a></li><li><a href="/guide/mapstruct.html" class="sidebar-link">Spring Boot 集成 MapStruct</a></li><li><a href="/guide/nacos.html" class="sidebar-link">整合 Nacos</a></li><li><a href="/guide/socketio.html" class="sidebar-link">netty-socketio</a></li><li><a href="/guide/nacos-eureka.html" class="sidebar-link">Alibaba Nacos 替换 Eureka 注册中心</a></li><li><a href="/guide/log.html" class="sidebar-link">日志规范</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开发工具</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev-tool/maven.html" class="sidebar-link">MAVEN</a></li><li><a href="/dev-tool/idea-plugin.html" class="sidebar-link">IDEA 插件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>DevOps</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops/docker-in-action.html" class="sidebar-link">Docker</a></li><li><a href="/devops/docker-compose.html" class="sidebar-link">Docker-Compose</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>更新日志</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/change-log/" class="sidebar-link">CHANGELOG</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="使用-feign-实现声明式-rest-调用"><a href="#使用-feign-实现声明式-rest-调用" class="header-anchor">#</a> 使用 Feign 实现声明式 REST 调用</h1> <p></p><div class="table-of-contents"><ul><li><a href="#设计原理">设计原理</a><ul><li><a href="#_1-基于面向接口的动态代理方式生成实现类">1. 基于面向接口的动态代理方式生成实现类</a></li><li><a href="#_2-根据contract协议规则-解析接口类的注解信息">2. 根据Contract协议规则，解析接口类的注解信息</a></li><li><a href="#_3-基于-requestbean-动态生成-request">3. 基于 RequestBean，动态生成 Request</a></li><li><a href="#_4-使用encoder-将bean转换成-http报文正文-消息解析和转码逻辑">4. 使用Encoder 将Bean转换成 Http报文正文（消息解析和转码逻辑）</a></li><li><a href="#_5-拦截器负责对请求和返回进行装饰处理">5. 拦截器负责对请求和返回进行装饰处理</a></li><li><a href="#_6-日志记录">6. 日志记录</a></li><li><a href="#_7-基于重试器发送http请求">7. 基于重试器发送HTTP请求</a></li></ul></li><li><a href="#实现原理">实现原理</a><ul><li><a href="#_1-feign-client-通过-okhttpclient-完成-request-到-response-的一次请求">1. Feign client 通过 OkHttpClient 完成 request 到 Response 的一次请求</a></li><li><a href="#_2-okhttp-执行层">2. okhttp 执行层</a></li><li><a href="#_3-同步请求">3. 同步请求</a></li><li><a href="#_4-连接器执行过程">4. 连接器执行过程</a></li><li><a href="#_5-okhttp-拦截器-retryandfollowupinterceptor-重试机制">5. Okhttp 拦截器 RetryAndFollowUpInterceptor 重试机制</a></li><li><a href="#_6-okhttp-拦截器-bridgeinterceptor-桥梁">6. Okhttp 拦截器 BridgeInterceptor 桥梁</a></li><li><a href="#_7-okhttp3-拦截器-cacheinterceptor-缓存">7. Okhttp3 拦截器  CacheInterceptor 缓存</a></li><li><a href="#_8-okhttp3-拦截器-connectinterceptor-连接">8. Okhttp3 拦截器 ConnectInterceptor 连接</a></li><li><a href="#_9-okhttp3-拦截器-callserverinterceptor-网络调用">9. Okhttp3 拦截器 CallServerInterceptor 网络调用</a></li><li><a href="#_10-connectionpool-实现">10. ConnectionPool 实现</a></li></ul></li><li><a href="#最佳实践">最佳实践</a><ul><li><a href="#整合-feign">整合 Feign</a></li><li><a href="#自定义feign配置">自定义Feign配置</a></li><li><a href="#使用feign构造多参数请求">使用Feign构造多参数请求</a></li><li><a href="#使用feign上传文件">使用Feign上传文件</a></li><li><a href="#feign-对继承的支持">Feign 对继承的支持</a></li><li><a href="#feign-对压缩的支持">Feign 对压缩的支持</a></li><li><a href="#feign-的日志">Feign 的日志</a></li></ul></li><li><a href="#常见问题">常见问题</a><ul><li><a href="#同时配置-feign-和-ribbon-的超时时间的优先级">同时配置 Feign 和 Ribbon 的超时时间的优先级</a></li><li><a href="#feign-启用hystrix-hystrix线程池隔离支持日志链路跟踪">feign 启用Hystrix，Hystrix线程池隔离支持日志链路跟踪</a></li><li><a href="#feign-使用okhttp3">Feign 使用OkHttp3</a></li><li><a href="#spring-cloud-之-feign、ribbon-设置超时时间">Spring Cloud 之 Feign、Ribbon 设置超时时间</a></li><li><a href="#feign-长连接导致的异常">Feign 长连接导致的异常</a></li><li><a href="#hystrix线程池如何合理配置">hystrix线程池如何合理配置</a></li><li><a href="#何时会出现-hystrix-circuit-short-circuited-and-is-open">何时会出现 Hystrix circuit short-circuited and is OPEN</a></li></ul></li></ul></div><p></p> <h2 id="设计原理"><a href="#设计原理" class="header-anchor">#</a> 设计原理</h2> <p>Feign 的设计
<img src="/img/spring-cloud-feign/feign-design.png" alt="feign-design"></p> <h3 id="_1-基于面向接口的动态代理方式生成实现类"><a href="#_1-基于面向接口的动态代理方式生成实现类" class="header-anchor">#</a> 1. 基于面向接口的动态代理方式生成实现类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// feign.ReflectiveFeign.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectiveFeign</span> <span class="token keyword">extends</span> <span class="token class-name">Feign</span> <span class="token punctuation">{</span>

  <span class="token comment">//...</span>

  <span class="token comment">/**
   * creates an api binding to the {@code target}. As this invokes reflection, care should be taken
   * to cache the result.
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Target</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//根据接口类和Contract协议解析方式，解析接口类上的方法和注解，转换成内部的MethodHandler处理方式</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">MethodHandler</span><span class="token punctuation">&gt;</span></span> nameToHandler <span class="token operator">=</span> targetToHandlersByName<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">MethodHandler</span><span class="token punctuation">&gt;</span></span> methodToHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">MethodHandler</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultMethodHandler</span><span class="token punctuation">&gt;</span></span> defaultMethodHandlers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultMethodHandler</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//...</span>
    
    <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> methodToHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 基于Proxy.newProxyInstance 为接口类创建动态实现，将所有的请求转换给InvocationHandler处理</span>
    <span class="token class-name">T</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>target<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DefaultMethodHandler</span> defaultMethodHandler <span class="token operator">:</span> defaultMethodHandlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      defaultMethodHandler<span class="token punctuation">.</span><span class="token function">bindTo</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p><strong>项目启动时</strong>的效果如下：
<img src="/img/spring-cloud-feign/feign-proxy.png" alt="feign-proxy"></p> <h3 id="_2-根据contract协议规则-解析接口类的注解信息"><a href="#_2-根据contract协议规则-解析接口类的注解信息" class="header-anchor">#</a> 2. 根据Contract协议规则，解析接口类的注解信息</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// feign.Contract.java</span>
<span class="token comment">/**
 * Defines what annotations and values are valid on interfaces.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Contract</span> <span class="token punctuation">{</span>

  <span class="token comment">/**
   * Called to parse the methods in the class that are linked to HTTP requests.
   *
   * @param targetType {@link feign.Target#type() type} of the Feign interface.
   */</span>
  <span class="token comment">// TODO: break this and correct spelling at some point</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodMetadata</span><span class="token punctuation">&gt;</span></span> <span class="token function">parseAndValidatateMetadata</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>项目启动时</strong>的效果如下：
<img src="/img/spring-cloud-feign/feign-contract.png" alt="feign-contract"></p> <p>Feign 默认的协议规范: <a href="https://github.com/OpenFeign/feign#interface-annotations" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <img src="/img/spring-cloud-feign/feign-default-contract.png" alt="feign-default-contract"></p> <p>在Spring Boot(Cloud)中，Feign 默认使用的契约是 SpringMvcContract, 因此它可以使用 SpringMvc 的注解。</p> <p>如果让它使用 Feign 自带的注解进行工作，需要自定义 Feign 的配置：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 该类为Feign的配置类
 * &lt;p&gt;
 * 注意：该类可以不写 @Configuration 注解；如果加了 @Configuration 注解，那么该类不能放在主应用程序上下文 @ComponentScan 所扫描的包中，否则会使项目中默认的 Feign 配置类发生变化
 *
 * @author :    zhangquansheng
 * @date :    2020/7/9 18:40
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignConfiguration</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 将契约改为feign原生的默认契约。这样就可以使用feign自带的注解了。
     *
     * @return 默认的feign契约
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Contract</span> <span class="token function">feignContract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">feign<span class="token punctuation">.</span></span>Contract<span class="token punctuation">.</span>Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>禁止使用原生Feign注解调用feign接口</p> <ol><li>书写不方便，极容易出错</li> <li>Spring Cloud <a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-openfeign/3.0.0.M1/reference/html/#spring-cloud-feign-overriding-defaults" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中默认使用 <code>SpringMvcContract</code></li></ol></div> <h3 id="_3-基于-requestbean-动态生成-request"><a href="#_3-基于-requestbean-动态生成-request" class="header-anchor">#</a> 3. 基于 RequestBean，动态生成 Request</h3> <p><code>feign.ReflectiveFeign.BuildTemplateByResolvingArgs</code> 实现了<code>RequestTemplate.Factory</code>,通过以上动态代理生成的<code>MethodHandler</code> 和 <code>Object[] argv</code> 生成 <code>RequestTemplate</code> , 源码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// feign.ReflectiveFeign.BuildTemplateByResolvingArgs.java</span>
 <span class="token comment">//...</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RequestTemplate</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">RequestTemplate</span> mutable <span class="token operator">=</span> <span class="token class-name">RequestTemplate</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">return</span> template<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 <span class="token comment">//...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>然后 <code>RequestTemplate</code> 根据<code>targetRequest</code>方法转换成真正的<code>Request</code>请求, 源码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// feign.SynchronousMethodHandler.java</span>
<span class="token comment">//...</span>

  <span class="token class-name">Request</span> <span class="token function">targetRequest</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestInterceptor</span> interceptor <span class="token operator">:</span> requestInterceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      interceptor<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">//...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_4-使用encoder-将bean转换成-http报文正文-消息解析和转码逻辑"><a href="#_4-使用encoder-将bean转换成-http报文正文-消息解析和转码逻辑" class="header-anchor">#</a> 4. 使用Encoder 将Bean转换成 Http报文正文（消息解析和转码逻辑）</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// feign.SynchronousMethodHandler</span>

<span class="token class-name">Object</span> <span class="token function">executeAndDecode</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">,</span> <span class="token class-name">Options</span> options<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
        response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>程序运行时</strong>数据结构如下：
<img src="/img/spring-cloud-feign/feign-request-response.png" alt="feign-request-response.png"></p> <h3 id="_5-拦截器负责对请求和返回进行装饰处理"><a href="#_5-拦截器负责对请求和返回进行装饰处理" class="header-anchor">#</a> 5. 拦截器负责对请求和返回进行装饰处理</h3> <p>在请求转换的过程中，Feign 抽象出来了拦截器接口，用于用户自定义对请求的操作：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// feign.RequestInterceptor.java</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{</span>

  <span class="token comment">/**
   * 可以在构造RequestTemplate 请求时，增加或者修改Header, Method, Body 等信息
   * Called for every request. Add data using methods on the supplied {@link RequestTemplate}.
   */</span>
  <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_6-日志记录"><a href="#_6-日志记录" class="header-anchor">#</a> 6. 日志记录</h3> <p>在发送和接收请求的时候，Feign定义了统一的日志门面来输出日志信息 , 并且将日志的输出定义了四个等级：</p> <table><thead><tr><th>级别</th> <th style="text-align:right;">说明</th></tr></thead> <tbody><tr><td>NONE</td> <td style="text-align:right;">不做任何记录</td></tr> <tr><td>BASIC</td> <td style="text-align:right;">只记录输出Http 方法名称、请求URL、返回状态码和执行时间</td></tr> <tr><td>HEADERS</td> <td style="text-align:right;">记录输出Http 方法名称、请求URL、返回状态码和执行时间 和 Header 信息</td></tr> <tr><td>FULL</td> <td style="text-align:right;">记录Request 和Response的Header，Body和一些请求元数据</td></tr></tbody></table> <div class="custom-block tip"><p class="custom-block-title">特别提示</p> <p>日志规范中，对于外部接口部分的要求是：调用第三方时的调用参数和调用结果要打印Info级别的日志,由于Feign配置FULL级别的情况下，需要配置Debug级别才能打印所需要的日志。</p> <p>在最佳实践中，配置修改了Feign的日志输出为INFO级别。</p></div> <h3 id="_7-基于重试器发送http请求"><a href="#_7-基于重试器发送http请求" class="header-anchor">#</a> 7. 基于重试器发送HTTP请求</h3> <p>Feign 内置了一个重试器，当HTTP请求出现IO异常时，Feign会有一个最大尝试次数发送请求</p> <p>重试器有如下几个控制参数：</p> <table><thead><tr><th>重试参数</th> <th style="text-align:right;">说明</th> <th style="text-align:right;">默认值</th></tr></thead> <tbody><tr><td>period</td> <td style="text-align:right;">初始重试时间间隔，当请求失败后，重试器将会暂停 初始时间间隔(线程 sleep 的方式)后再开始，避免强刷请求，浪费性能</td> <td style="text-align:right;">100ms</td></tr> <tr><td>maxPeriod</td> <td style="text-align:right;">当请求连续失败时，重试的时间间隔将按照：long interval = (long) (period * Math.pow(1.5, attempt - 1)); 计算，按照等比例方式延长，但是最大间隔时间为  maxPeriod, 设置此值能够避免 重试次数过多的情况下执行周期太长</td> <td style="text-align:right;">1000ms</td></tr> <tr><td>maxAttempts</td> <td style="text-align:right;">最大重试次数</td> <td style="text-align:right;">5</td></tr></tbody></table> <p><strong>使用微服务(Spring Cloud)一般情况下，都是 ribbon 的超时时间（&lt;）hystrix的超时时间（因为涉及到ribbon的重试机制）因为ribbon的重试机制和Feign的重试机制有冲突，所以源码中默认关闭Feign的重试机制</strong></p> <h2 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h2> <h3 id="_1-feign-client-通过-okhttpclient-完成-request-到-response-的一次请求"><a href="#_1-feign-client-通过-okhttpclient-完成-request-到-response-的一次请求" class="header-anchor">#</a> 1. Feign client 通过 OkHttpClient 完成 request 到 Response 的一次请求</h3> <p>使用 feign.okhttp.OkHttpClient   (注意和okhttp3.OkHttpClient是不一样的),</p> <p>实际上处理 HTTP URL 请求的是 feignClient(…) 方法中的 feign.okhttp.OkHttpClient.execute(…) 方法，源码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//feign.okhttp.OkHttpClient.java</span>
 
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">feign<span class="token punctuation">.</span></span>Response</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">feign<span class="token punctuation">.</span></span>Request</span> input<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">feign<span class="token punctuation">.</span></span>Request<span class="token punctuation">.</span>Options</span> options<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>OkHttpClient</span> requestScoped<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">connectTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> options<span class="token punctuation">.</span><span class="token function">connectTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> delegate<span class="token punctuation">.</span><span class="token function">readTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> options<span class="token punctuation">.</span><span class="token function">readTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      requestScoped <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">connectTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">readTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">followRedirects</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">isFollowRedirects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      requestScoped <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token function">toOkHttpRequest</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// okhttp 执行层, 其中requestScoped 是 okhttp3.OkHttpClient 的实例</span>
    <span class="token class-name">Response</span> response <span class="token operator">=</span> requestScoped<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">toFeignResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>在默认没有配置的情况下，Options的初始化参数如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Options</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// connectTimeoutMillis = 10_000</span>
<span class="token comment">// readTimeoutMillis = 60_000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>也可以通过配置文件来修改默认配置，配置如下：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">//</span> <span class="token value attr-value">default 为默认的，也可以根据feign的value值，单独配置</span>
<span class="token key attr-name">feign.client.config.default.connectTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span>
<span class="token key attr-name">feign.client.config.default.readTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">10000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>从源码可以看到，feign使用okhttp时，超时时间优先根据client的时间来设置。</p> <h3 id="_2-okhttp-执行层"><a href="#_2-okhttp-执行层" class="header-anchor">#</a> 2. okhttp 执行层</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 其中requestScoped 是 okhttp3.OkHttpClient 的实例</span>
<span class="token class-name">Response</span> response <span class="token operator">=</span> requestScoped<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这是应用程序中发起网络请求最顶端的调用，newCall(request) 方法返回 RealCall 对象。</p> <p>RealCall 封装了一个 request 代表一个请求调用任务，RealCall 有两个重要的方法 execute() 和 enqueue(Callback responseCallback)。</p> <p>execute() 是直接在当前线程执行请求，enqueue(Callback responseCallback) 是将当前任务加到任务队列中，执行异步请求。</p> <h3 id="_3-同步请求"><a href="#_3-同步请求" class="header-anchor">#</a> 3. 同步请求</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// okhttp3.RealCall.java</span>

  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Response</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Already Executed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      executed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">captureCallStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      client<span class="token punctuation">.</span><span class="token function">dispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">executed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Response</span> result <span class="token operator">=</span> <span class="token function">getResponseWithInterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Canceled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      client<span class="token punctuation">.</span><span class="token function">dispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>从执行层说到连接层，涉及到 <code>getResponseWithInterceptorChain</code> 方法中组织的各个拦截器的执行过程，其中 <code>getResponseWithInterceptorChain</code> 是关键，它使用了<strong>责任链设计模式</strong></p> <h3 id="_4-连接器执行过程"><a href="#_4-连接器执行过程" class="header-anchor">#</a> 4. 连接器执行过程</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// okhttp3.RealCall.java</span>

  <span class="token class-name">Response</span> <span class="token function">getResponseWithInterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// Build a full stack of interceptors.</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Interceptor</span><span class="token punctuation">&gt;</span></span> interceptors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    interceptors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">interceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>retryAndFollowUpInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BridgeInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">cookieJar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">internalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConnectInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forWebSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      interceptors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">networkInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CallServerInterceptor</span><span class="token punctuation">(</span>forWebSocket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Interceptor<span class="token punctuation">.</span>Chain</span> chain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealInterceptorChain</span><span class="token punctuation">(</span>
        interceptors<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> originalRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>originalRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_5-okhttp-拦截器-retryandfollowupinterceptor-重试机制"><a href="#_5-okhttp-拦截器-retryandfollowupinterceptor-重试机制" class="header-anchor">#</a> 5. Okhttp 拦截器 RetryAndFollowUpInterceptor 重试机制</h3> <p>此拦截器将从故障中恢复，并根据需要执行重定向。如果调用被取消，它会抛出 *{@link IOException}</p> <p>关于重定向次数：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * How many redirects and auth challenges should we attempt? Chrome follows 21 redirects; Firefox,
 * curl, and wget follow 20; Safari follows 16; and HTTP/1.0 recommends 5.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_FOLLOW_UPS</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_6-okhttp-拦截器-bridgeinterceptor-桥梁"><a href="#_6-okhttp-拦截器-bridgeinterceptor-桥梁" class="header-anchor">#</a> 6. Okhttp 拦截器 BridgeInterceptor 桥梁</h3> <blockquote><p>一个实现应用层和网络层直接的数据格式编码的桥。</p> <ul><li>第一： 把应用层客户端传过来的请求对象转换为 Http 网络协议所需字段的请求对象。</li> <li>第二:  把下游网络请求结果转换为应用层客户所需要的响应对象</li></ul></blockquote> <p>默认设置HTTP长连接（开启Keep-Alive功能可使客户端到服务器端的连接持续有效,当出现对服务器的后继请求时,Keep-Alive功能避免了建立或者重新建立连接。）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>userRequest<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  requestBuilder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Keep-Alive&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_7-okhttp3-拦截器-cacheinterceptor-缓存"><a href="#_7-okhttp3-拦截器-cacheinterceptor-缓存" class="header-anchor">#</a> 7. Okhttp3 拦截器  CacheInterceptor 缓存</h3> <p>为来自缓存的请求提供服务，并将响应写入缓存</p> <h3 id="_8-okhttp3-拦截器-connectinterceptor-连接"><a href="#_8-okhttp3-拦截器-connectinterceptor-连接" class="header-anchor">#</a> 8. Okhttp3 拦截器 ConnectInterceptor 连接</h3> <p>打开到目标服务器的连接并继续到下一个拦截器。</p> <h3 id="_9-okhttp3-拦截器-callserverinterceptor-网络调用"><a href="#_9-okhttp3-拦截器-callserverinterceptor-网络调用" class="header-anchor">#</a> 9. Okhttp3 拦截器 CallServerInterceptor 网络调用</h3> <p>这是链中的最后一个拦截器。它对服务器进行网络调用。
<img src="/img/spring-cloud-feign/okhttp3-1.png" alt="okhttp3"></p> <h3 id="_10-connectionpool-实现"><a href="#_10-connectionpool-实现" class="header-anchor">#</a> 10. ConnectionPool 实现</h3> <p><img src="/img/spring-cloud-feign/okhttp3-2.png" alt="okhttp3"></p> <blockquote><p>管理HTTP和HTTP/2连接的重用以减少网络延迟
HTTP请求共享同一{@link Address} ，共享同一{@link Connection}
实现策略为将来使用而保持开放的连接。</p></blockquote> <p>默认实现中，使用一个双向队列来缓存所有连接， 这些连接中最多只能存在 5 个空闲连接，空闲连接最多只能存活 5 分钟。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * Create a new connection pool with tuning parameters appropriate for a single-user application.
 * The tuning parameters in this pool are subject to change in future OkHttp releases. Currently
 * this pool holds up to 5 idle connections which will be evicted after 5 minutes of inactivity.
 */</span>
<span class="token keyword">public</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如何复用Connection：遍历了所有的连接，然后判断某个连接是否可以复用；http1.x协议下当前socket没有其他流正在读写时可以复用，否则不行，http2.0对流数量没有限制。</p> <p>如何清理连接池：每次put一个新连接的时候都会判断是否需要清理。遍历当前所有连接，跳过正在使用的连接，其他没有用的连接，如果哪个连接超过了规定的时间，就关掉这个socket。如果都没有超过规定时间的，就返回离规定时间最近的那个差值。拿到那个时间值后，我们再回到上面那个cleanupRunnable中，在那里会wait线程，然后醒来继续清理</p> <h2 id="最佳实践"><a href="#最佳实践" class="header-anchor">#</a> 最佳实践</h2> <h3 id="整合-feign"><a href="#整合-feign" class="header-anchor">#</a> 整合 Feign</h3> <ol><li>添加依赖</li></ol> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="2"><li>启用Feign</li></ol> <p>启用类上添加注解<code>@EnableFeignClients</code>客户端允许开启使用Feign调用，扫描<code>@FeignClient</code>标注的FeignClient接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">FeignApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>创建一个Feign接口，并添加<code>@FeignClient</code>注解。</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;sso&quot;</span><span class="token punctuation">,</span> url <span class="token operator">=</span> <span class="token string">&quot;https://t-sso.gaodun.com&quot;</span><span class="token punctuation">,</span> fallbackFactory <span class="token operator">=</span> <span class="token class-name">SsoFeignClientFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SsoFeignClient</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 学生 ID 获取用户信息
     *
     * @param userId 学生 ID
     * @return 用户信息
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/getbaseuserinfo/{userid}&quot;</span><span class="token punctuation">,</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;x-origin=gaodun.com&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token class-name">BaseUserInfoResponse</span> <span class="token function">getBaseUserInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;userid&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="自定义feign配置"><a href="#自定义feign配置" class="header-anchor">#</a> 自定义Feign配置</h3> <p>Feign 支持使用属性自定义，这种方式比使用Java代码配置的方式更加方便。</p> <ol><li>配置指定名称的Feign Client</li></ol> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">sso</span><span class="token punctuation">:</span>
        <span class="token comment"># 相当于Request.Options</span>
        <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
        <span class="token comment"># 相当于Request.Options</span>
        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
        <span class="token comment"># 配置Feign的日志级别，相当于代码配置方式中的Logger</span>
        <span class="token key atrule">loggerLevel</span><span class="token punctuation">:</span> FULL
        <span class="token comment"># Feign 的错误解码器，相当于代码配置方式中的ErrorDecoder</span>
        <span class="token key atrule">errorDecoder</span><span class="token punctuation">:</span> com.example.SimpleErrorDecoder
        <span class="token comment"># 配置重试，相当于代码配置方式中的Retryer</span>
        <span class="token key atrule">retryer</span><span class="token punctuation">:</span> com.example.SimpleRetryer
        <span class="token comment"># 配置拦截器，相当于代码配置方式中的RequestInterceptor</span>
        <span class="token key atrule">requestInterceptors</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> com.example.FooRequestInterceptor
         <span class="token punctuation">-</span> com.example.BarRequestInterceptor
        <span class="token key atrule">decode404</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ol start="2"><li>通用配置</li></ol> <p>如果想配置所有的Feign Client，只需要做如下配置即可：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>属性配置的方式比Java代码配置的方式优先级更高，如果你想让Java代码配置方式优先级更高，可使用这个属性：feign.client.default-to-properties=false。</p></div> <h3 id="使用feign构造多参数请求"><a href="#使用feign构造多参数请求" class="header-anchor">#</a> 使用Feign构造多参数请求</h3> <p>以GET已经POST方法请求为例，其他的方法（例如DELETE、PUT等）的请求原理相同。</p> <ul><li>GET 请求多参数的 URL</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/get&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">User</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>POST 请求包含多个参数</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/post&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">User</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>POST <code>Content-Type=application/x-www-form-urlencoded</code> 提交表单</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/post&quot;</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_FORM_URLENCODED_VALUE</span><span class="token punctuation">)</span>
    <span class="token keyword">void</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token class-name">MultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> formData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p><code>application/x-www-form-urlencoded</code> 提交表单的方式下，不能使用<code>@RequestBody</code>，否则会异常：<code>feign.codec.EncodeException: Could not write request: no suitable HttpMessageConverter found for</code></p></div> <h3 id="使用feign上传文件"><a href="#使用feign上传文件" class="header-anchor">#</a> 使用Feign上传文件</h3> <p>在实际应用中，我们可能会使用 Feign上传文件，Feign 官方提供了子项目 <a href="https://github.com/OpenFeign/feign-form" target="_blank" rel="noopener noreferrer">feign-form<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，
其中实现了上传所需的 Encoder。下面是使用 Feign上传文件的主要步骤：</p> <ol><li>为应用添加 feign-form 相关依赖</li></ol> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign.form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign.form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-form-spring<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="2"><li>可以将表单编码器与Spring MultipartFile和@FeignClient一起使用</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>
    name <span class="token operator">=</span> <span class="token string">&quot;file-upload-service&quot;</span><span class="token punctuation">,</span>
    configuration <span class="token operator">=</span> <span class="token class-name">FileUploadServiceClient<span class="token punctuation">.</span>MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FileUploadServiceClient</span> <span class="token keyword">extends</span> <span class="token class-name">IFileUploadServiceClient</span> <span class="token punctuation">{</span>
    
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/upload&quot;</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span> 
  <span class="token class-name">String</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultipartSupportConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpMessageConverters</span><span class="token punctuation">&gt;</span></span> messageConverters<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Encoder</span> feignFormEncoder <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SpringFormEncoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SpringEncoder</span><span class="token punctuation">(</span>messageConverters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="feign-对继承的支持"><a href="#feign-对继承的支持" class="header-anchor">#</a> Feign 对继承的支持</h3> <p>Feign支持继承。使用继承，可将一些公共操作分组到一些父接口中，从而简化Feign的开发。</p> <p>UserService.java</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> value <span class="token operator">=</span><span class="token string">&quot;/users/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">User</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>UserResource.java</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserResource</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>UserClient.java</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">project<span class="token punctuation">.</span>user</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserClient</span> <span class="token keyword">extends</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>尽管Feign的继承可帮助我们进一步简化开发，但是Spring Cloud指出——通常情况下，不建议服务器端和客户端之间共享接口，因为这种方式会造成服务器端和客户端代码的紧耦合。
并且，Feign本身并不使用Spring MVC的工作机制（方法参数映射不被继承）。</p></div> <p>应客观看待“紧耦性”与“方便性”，并在权衡利弊后作出取舍，<strong>个人推荐内部接口服务可使用继承的方式提供一个feign的客户端,这样会大大方便内部接口的对接。</strong></p> <h3 id="feign-对压缩的支持"><a href="#feign-对压缩的支持" class="header-anchor">#</a> Feign 对压缩的支持</h3> <p>在一些场景下，可能需要对请求或响应进行压缩，此时可使用启用Feign的压缩功能。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">feign.compression.request.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token key attr-name">feign.compression.response.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对于请求的压缩，Feign还提供了更为详细的设置，例如：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">feign.compression.request.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token key attr-name">feign.compression.request.mime-types</span><span class="token punctuation">=</span><span class="token value attr-value">text/xml,application/xml,application/json</span>
<span class="token key attr-name">feign.compression.request.min-request-size</span><span class="token punctuation">=</span><span class="token value attr-value">2048</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>其中，feign.compression.request.mime-types 用于支持的媒体类型列表，默认是 text/xml,application/xml,application/json
feign.compression.request.min-request-size 用于设置请求的最小阈值，默认是2048</p> <h3 id="feign-的日志"><a href="#feign-的日志" class="header-anchor">#</a> Feign 的日志</h3> <p>Feign对日志的处理非常灵活，可为每个Feign客户端指定日志记录策略，每个Feign客户端都会创建一个logger。
默认情况下，logger的名称是Feign接口的完整类名。需要注意的是，Feign的日志打印只会对DEBUG级别作出响应。
我们可为每个Feign客户端配置各自的Logger.Level对象，告诉Feign记录那些日志。</p> <p>Logger.Level的值有以下选择：</p> <ul><li>NONE：不记录任何日志（默认值）</li> <li>BASIC：仅记录请求方法、URL、响应状态代码以及执行时间</li> <li>HEADERS：记录BASIC级别的基础上，记录请求和响应的header</li> <li>FULL：记录请求和响应的header，body和元数据</li></ul> <p>下面为前面编写的<code>SsoFeignClient</code>添加日志打印，将它的日志级别设置为FULL。</p> <ol><li>编写Feign配置类：</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignLogConfiguration</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span> <span class="token function">feignLoggerLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span><span class="token constant">FULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>修改 Feign 的接口，指定配置类:</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;sso&quot;</span><span class="token punctuation">,</span> url <span class="token operator">=</span> <span class="token string">&quot;https://t-sso.gaodun.com&quot;</span><span class="token punctuation">,</span> fallbackFactory <span class="token operator">=</span> <span class="token class-name">SsoFeignClientFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">FeignLogConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SsoFeignClient</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 学生 ID 获取用户信息
     *
     * @param userId 学生 ID
     * @return 用户信息
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/getbaseuserinfo/{userid}&quot;</span><span class="token punctuation">,</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;x-origin=gaodun.com&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token class-name">BaseUserInfoResponse</span> <span class="token function">getBaseUserInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;userid&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="3"><li>在 <code>application.yml</code>中添加一下内容，指定Feign接口的日志级别为DEBUG:</li></ol> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">com.zhengcheng.magic.feign.SsoFeignClient</span><span class="token punctuation">:</span> DEBUG <span class="token comment"># 将Feign接口的日志级别设置为DEBUG，因为Feign的Logger.Level只对DEBUG作出响应</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="日志自定义扩展"><a href="#日志自定义扩展" class="header-anchor">#</a> 日志自定义扩展</h4> <p>与外部HTTP接口交互时需要记录一些请求和响应日志来排查问题，虽然Feign支持但它的日志是Debug级别，并不符合我们在生产中使用INFO级别日志要求。</p> <ol><li>实现FeignLoggerFactory工厂接口,InfoFeignLoggerFactory 是FeignConfig静态内部类</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InfoFeignLoggerFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FeignLoggerFactory</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Logger</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InfoFeignLogger</span><span class="token punctuation">(</span><span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="2"><li>继承feign.Logger实现info级别日志输出，InfoFeignLogger使用slf4j日志工具</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InfoFeignLogger</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">feign<span class="token punctuation">.</span></span>Logger</span> <span class="token punctuation">{</span>

    <span class="token comment">// 建议使用slf4j这样项目在更换日志框架也不用修改源代码了，扩展性更强</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span>Logger</span> logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">InfoFeignLogger</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span>Logger</span> logger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">String</span> configKey<span class="token punctuation">,</span> <span class="token class-name">String</span> format<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token function">methodTag</span><span class="token punctuation">(</span>configKey<span class="token punctuation">)</span> <span class="token operator">+</span> format<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="3"><li>日志工厂InfoFeignLoggerFactory注册到spring 容器中</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Feign</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureBefore</span><span class="token punctuation">(</span><span class="token class-name">FeignAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignOkHttpConfig</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
    <span class="token comment">/**
     * Feign 日志级别
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span> <span class="token function">feignLoggerLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span><span class="token constant">FULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">FeignLoggerFactory</span> <span class="token function">infoFeignLoggerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InfoFeignLoggerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h2> <h3 id="同时配置-feign-和-ribbon-的超时时间的优先级"><a href="#同时配置-feign-和-ribbon-的超时时间的优先级" class="header-anchor">#</a> 同时配置 Feign 和 Ribbon 的超时时间的优先级</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// LoadBalancerFeignClient.java</span>
  <span class="token class-name">IClientConfig</span> <span class="token function">getClientConfig</span><span class="token punctuation">(</span><span class="token class-name">Request<span class="token punctuation">.</span>Options</span> options<span class="token punctuation">,</span> <span class="token class-name">String</span> clientName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> requestConfig<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">==</span> <span class="token constant">DEFAULT_OPTIONS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            requestConfig <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientFactory<span class="token punctuation">.</span><span class="token function">getClientConfig</span><span class="token punctuation">(</span>clientName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            requestConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FeignOptionsClientConfig</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">IClientConfig</span><span class="token punctuation">)</span>requestConfig<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="feign-启用hystrix-hystrix线程池隔离支持日志链路跟踪"><a href="#feign-启用hystrix-hystrix线程池隔离支持日志链路跟踪" class="header-anchor">#</a> feign 启用Hystrix，Hystrix线程池隔离支持日志链路跟踪</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MdcHystrixConcurrencyStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">HystrixConcurrencyStrategy</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">wrapCallable</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MdcAwareCallable</span><span class="token punctuation">(</span>callable<span class="token punctuation">,</span> <span class="token constant">MDC</span><span class="token punctuation">.</span><span class="token function">getCopyOfContextMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">MdcAwareCallable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> delegate<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> contextMap<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">MdcAwareCallable</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> contextMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> callable<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>contextMap <span class="token operator">=</span> contextMap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> contextMap <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token constant">MDC</span><span class="token punctuation">.</span><span class="token function">setContextMap</span><span class="token punctuation">(</span>contextMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token constant">MDC</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Feign</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureBefore</span><span class="token punctuation">(</span><span class="token class-name">FeignAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignOkHttpConfig</span> <span class="token punctuation">{</span>
    
    <span class="token comment">//...</span>
    <span class="token keyword">public</span> <span class="token class-name">FeignOkHttpConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">HystrixConcurrencyStrategy</span> mdcTarget <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MdcHystrixConcurrencyStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HystrixConcurrencyStrategy</span> strategy <span class="token operator">=</span> <span class="token class-name">HystrixPlugins</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConcurrencyStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token keyword">instanceof</span> <span class="token class-name">MdcHystrixConcurrencyStrategy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">HystrixCommandExecutionHook</span> commandExecutionHook <span class="token operator">=</span> <span class="token class-name">HystrixPlugins</span>
                    <span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommandExecutionHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HystrixEventNotifier</span> eventNotifier <span class="token operator">=</span> <span class="token class-name">HystrixPlugins</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getEventNotifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HystrixMetricsPublisher</span> metricsPublisher <span class="token operator">=</span> <span class="token class-name">HystrixPlugins</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getMetricsPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HystrixPropertiesStrategy</span> propertiesStrategy <span class="token operator">=</span> <span class="token class-name">HystrixPlugins</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getPropertiesStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">HystrixPlugins</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HystrixPlugins</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerConcurrencyStrategy</span><span class="token punctuation">(</span>mdcTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HystrixPlugins</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">registerCommandExecutionHook</span><span class="token punctuation">(</span>commandExecutionHook<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HystrixPlugins</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventNotifier</span><span class="token punctuation">(</span>eventNotifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HystrixPlugins</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerMetricsPublisher</span><span class="token punctuation">(</span>metricsPublisher<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HystrixPlugins</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerPropertiesStrategy</span><span class="token punctuation">(</span>propertiesStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to register Hystrix Concurrency Strategy&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="feign-使用okhttp3"><a href="#feign-使用okhttp3" class="header-anchor">#</a> Feign 使用OkHttp3</h3> <p>在Feign中使用OkHttp作为网络请求框架，配置如下：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">feign.httpclient.enabled</span> <span class="token punctuation">=</span> <span class="token value attr-value">false</span>
<span class="token key attr-name">feign.okhttp.enabled</span> <span class="token punctuation">=</span> <span class="token value attr-value">true</span>
<span class="token key attr-name">feign.hystrix.enabled</span> <span class="token punctuation">=</span> <span class="token value attr-value">true  </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="spring-cloud-之-feign、ribbon-设置超时时间"><a href="#spring-cloud-之-feign、ribbon-设置超时时间" class="header-anchor">#</a> Spring Cloud 之 Feign、Ribbon 设置超时时间</h3> <p>Spring Cloud 下使用<code>Feign</code>调用接口分两层，<code>Ribbon</code>的调用和<code>Hystrix</code>的调用，超时时间配置如下：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">hystrix.command.default.execution.timeout.enabled</span> <span class="token punctuation">=</span> <span class="token value attr-value">true</span>
<span class="token key attr-name">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</span> <span class="token punctuation">=</span> <span class="token value attr-value">10000</span>

<span class="token key attr-name">ribbon.read-timeout</span> <span class="token punctuation">=</span> <span class="token value attr-value">5000</span>
<span class="token key attr-name">ribbon.connect-timeout</span> <span class="token punctuation">=</span> <span class="token value attr-value">5000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>一般情况下 都是<strong>Ribbon</strong>的超时时间（&lt;）<code>Hystrix</code>的超时时间（涉及到<code>Ribbon</code>的重试机制，且<strong>因为<code>Ribbon</code>的重试机制和<code>Feign</code>的重试机制有冲突，所以源码中默认关闭<code>Feign</code>的重试机制。</strong>）。</p> <p><strong>如果不配置<code>Ribbon</code>的重试次数，默认会重试一次。并且<code>GET</code>方式请求无论是连接异常还是读取异常，都会进行重试。非<code>GET</code>方式请求，只有连接异常时，才会进行重试。</strong></p> <h3 id="feign-长连接导致的异常"><a href="#feign-长连接导致的异常" class="header-anchor">#</a> Feign 长连接导致的异常</h3> <p>当使用 Feign 使用OkHttp3，默认配置如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// org.springframework.cloud.openfeign.FeignAutoConfiguration.java </span>
<span class="token comment">//...</span>
	<span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">ConnectionPool</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ConnectionPool</span> <span class="token function">httpClientConnectionPool</span><span class="token punctuation">(</span><span class="token class-name">FeignHttpClientProperties</span> httpClientProperties<span class="token punctuation">,</span>
                                                   <span class="token class-name">OkHttpClientConnectionPoolFactory</span> connectionPoolFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Integer</span> maxTotalConnections <span class="token operator">=</span> httpClientProperties<span class="token punctuation">.</span><span class="token function">getMaxConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> timeToLive <span class="token operator">=</span> httpClientProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeUnit</span> ttlUnit <span class="token operator">=</span> httpClientProperties<span class="token punctuation">.</span><span class="token function">getTimeToLiveUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> connectionPoolFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>maxTotalConnections<span class="token punctuation">,</span> timeToLive<span class="token punctuation">,</span> ttlUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Http1.1 协议下 <code>Connection:keep-Alive</code> 的时长为900秒（15分钟），这样容易出现<code>java.io.IOException : unexpected end of steam on</code>错误，解决方式如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//...</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${feign.okhttp3.connect-timeout.milliseconds}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> connectTimeout<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${feign.okhttp3.read-timeout.milliseconds}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> readTimeout<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${feign.okhttp3.write-timeout.milliseconds}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> writeTimeout<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>OkHttpClient</span> <span class="token function">okHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>OkHttpClient<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span>readTimeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span>writeTimeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectionPool</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>ConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>使用 okhttp3.ConnectionPool即可（不推荐直接关闭 <code>Connection:close</code>，开启Keep-Alive功能可使客户端到服务器端的连接持续有效,当出现对服务器的后继请求时,Keep-Alive功能避免了建立或者重新建立连接。）</p> <h3 id="hystrix线程池如何合理配置"><a href="#hystrix线程池如何合理配置" class="header-anchor">#</a> hystrix线程池如何合理配置</h3> <p><strong>下面就是我们线上大量系统优化后的生产经验总结：</strong></p> <p>假设你的服务A，每秒钟会接收30个请求，同时会向服务B发起30个请求，然后每个请求的响应时长经验值大概在200ms，那么你的hystrix线程池需要多少个线程呢？</p> <p><strong>计算公式是：30（每秒请求数量） * 0.2（每个请求的处理秒数） + 4（给点缓冲buffer） = 10（线程数量）</strong></p> <p>必须设置合理的参数，避免高峰期，频繁的hystrix线程卡死</p> <blockquote><p>如果hystix超时时间设置为500ms，那么1s中可以处理2个线程，所以如果需要让一个服务器达到100的并发，那么核心线程数需要配置到50才能达到处理每秒100的请求；</p></blockquote> <p>参考配置如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">10000</span>
    <span class="token key atrule">sso</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">3000</span>
  <span class="token key atrule">threadpool</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">coreSize</span><span class="token punctuation">:</span> <span class="token number">100</span>
      <span class="token key atrule">maxQueueSize</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">sso</span><span class="token punctuation">:</span>
      <span class="token key atrule">coreSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">maxQueueSize</span><span class="token punctuation">:</span> <span class="token number">100</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="何时会出现-hystrix-circuit-short-circuited-and-is-open"><a href="#何时会出现-hystrix-circuit-short-circuited-and-is-open" class="header-anchor">#</a> 何时会出现 <code>Hystrix circuit short-circuited and is OPEN</code></h3> <p>首先，Hystrix 的隔离策略有两种：分别是线程隔离和信号量隔离</p> <ul><li>线程池隔离: 使用该方式，HystrixCommand 将在<strong>单独的线程</strong>上执行，并发请求受到线程池中的线程数量的限制。</li> <li>信号量隔离：使用该方式，HystrixCommand 将在<strong>调用线程</strong>上执行，开销相对较小，并发请求受到信号量个数的限制。</li></ul> <p>Hystrix 中默认并且推荐使用线程隔离，因为这种方式有一个除网络超时以外的额外保护层。</p> <p>那么在默认的情况（线程隔离）下，何种情况下回出现<code>Hystrix circuit short-circuited and is OPEN</code>？</p> <ul><li>当配置的<code>hystrix.threadpool.default.coreSize</code>、<code>hystrix.threadpool.default.maxQueueSize</code> 的大小（如果不配置，默认都是10）不满足接口并发的请求的情况下；</li> <li>服务提供者不可用，是否开启熔断器主要由依赖调用的错误比率决定的，依赖调用的错误比率=请求失败数/请求总数(默认50%)。还有一个参数，用于设置在一个滚动窗口中，打开断路器的最少请求数（默认20）。</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 当在配置时间窗口内达到此数量的失败后，进行短路。默认20个</span>
hystrix.command.default.circuitBreaker.requestVolumeThreshold = 20
<span class="token comment"># 短路多久以后开始尝试是否恢复，默认5s</span>
hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds = 5000
<span class="token comment"># 出错百分比阈值，当达到此阈值后，开始短路。默认50%</span>
hystrix.command.default.circuitBreaker.errorThresholdPercentage = 50
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><a href="https://github.com/Netflix/Hystrix/wiki/Configuration" target="_blank" rel="noopener noreferrer">参数说明<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>下面通过使用 Hystrix Dashboard 可视化监控数据来体验一下效果：
<img src="/img/spring-cloud-feign/hystrix-sso.png" alt="hystrix-sso.png"></p> <hr> <p><strong>参考文档</strong> <a href="https://docs.spring.io/spring-cloud-openfeign/docs/2.2.4.RELEASE/reference/html/#spring-cloud-feign" target="_blank" rel="noopener noreferrer">Spring Cloud OpenFeign 官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">a year ago</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/spring-boot/ContiPerf.html" class="prev">
        Spring Boot - 性能测试 ContiPerf
      </a></span> <span class="next"><a href="/spring-cloud/feign-dubbo.html">
        以Dubbo暴露服务的方式使用Feign（Feign 继承）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ead2daf9.js" defer></script><script src="/assets/js/2.a6437284.js" defer></script><script src="/assets/js/194.f5088931.js" defer></script>
  </body>
</html>
